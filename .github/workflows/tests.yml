---
# Temporary override: reuse existing workflow name to trigger run-eval logic from this branch.
name: Run SDK Eval (via tests workflow)

on:
    workflow_dispatch:
        inputs:
            branch:
                description: Branch or tag to evaluate
                required: true
                default: main
            eval_instances:
                description: Number of SWE-bench instances
                required: true
                default: '50'
                type: choice
                options:
                    - '1'
                    - '5'
                    - '50'
                    - '200'
            model:
                description: Model configuration to evaluate
                required: true
                default: sonnet-4-5
                type: choice
                options:
                    - sonnet-4-5
                    - haiku-4-5
            reason:
                description: Reason for manual trigger
                required: false
                default: ''

env:
    MASTER_EVAL_ISSUE_NUMBER: ${{ vars.MASTER_EVAL_ISSUE_NUMBER || '0' }}
    BENCHMARKS_REPO: https://github.com/OpenHands/benchmarks.git
    BENCHMARKS_REF: main
    MODELS_JSON: >-
        [
          {"id":"sonnet-4-5","llm_model":"litellm_proxy/anthropic/claude-sonnet-4-5-20250929","display_name":"Claude 3.5 Sonnet"},
          {"id":"haiku-4-5","llm_model":"litellm_proxy/anthropic/claude-haiku-4-5-20251001","display_name":"Claude 3.5 Haiku"}
        ]
    RELEASE_INSTANCE_COUNT: '200'

jobs:
    trigger-eval:
        name: Trigger remote eval
        runs-on: blacksmith-4vcpu-ubuntu-2204
        permissions:
            contents: read
            issues: write
            pull-requests: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Determine evaluation parameters
              id: params
              env:
                  EVENT_PATH: ${{ github.event_path }}
                  MASTER_ISSUE: ${{ env.MASTER_EVAL_ISSUE_NUMBER }}
                  REPO: ${{ github.repository }}
                  RUN_ID: ${{ github.run_id }}
                  MODELS_JSON: ${{ env.MODELS_JSON }}
                  RELEASE_INSTANCE_COUNT: ${{ env.RELEASE_INSTANCE_COUNT }}
              run: |
                  python <<'PY'
                  import json
                  import os

                  def emit(key: str, value: str) -> None:
                      with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
                          fh.write(f"{key}={value}\n")

                  models = {m["id"]: m for m in json.loads(os.environ["MODELS_JSON"])}
                  event = json.load(open(os.environ["EVENT_PATH"], "r", encoding="utf-8"))

                  sdk_ref = event["inputs"]["branch"]
                  model_id = event["inputs"]["model"]
                  eval_instances = event["inputs"]["eval_instances"]
                  reason = event["inputs"].get("reason", "Manual trigger")

                  target = models.get(model_id)
                  if not target:
                      raise SystemExit(f"Unsupported model '{model_id}'")

                  emit("sdk_ref", sdk_ref)
                  emit("pr_number", os.environ["MASTER_ISSUE"])
                  emit("model_id", model_id)
                  emit("llm_model", target["llm_model"])
                  emit("model_display", target["display_name"])
                  emit("eval_instances", eval_instances)
                  emit("trigger_desc", f"Proxy trigger ({reason})")
                  emit("trigger_type", "manual")
                  emit("trigger_url", f"https://github.com/{os.environ['REPO']}/actions/runs/{os.environ['RUN_ID']}")
                  emit("models_text", f"{target['display_name']} ({eval_instances})")
                  PY

            - name: Trigger evaluation workflow
              env:
                  PAT_TOKEN: ${{ secrets.ALLHANDS_BOT_GITHUB_PAT }}
                  SDK_REPO: https://github.com/${{ github.repository }}
                  SDK_REF: ${{ steps.params.outputs.sdk_ref }}
                  PR_NUMBER: ${{ steps.params.outputs.pr_number }}
                  EVAL_INSTANCES: ${{ steps.params.outputs.eval_instances }}
                  MODEL_ID: ${{ steps.params.outputs.model_id }}
                  LLM_MODEL: ${{ steps.params.outputs.llm_model }}
                  TRIGGER_DESC: ${{ steps.params.outputs.trigger_desc }}
                  TRIGGER_TYPE: ${{ steps.params.outputs.trigger_type }}
                  BENCHMARKS_REPO: ${{ env.BENCHMARKS_REPO }}
                  BENCHMARKS_REF: ${{ env.BENCHMARKS_REF }}
              run: |
                  if [ -z "$PAT_TOKEN" ]; then
                    echo "PAT_TOKEN is required to dispatch remote workflow"
                    exit 1
                  fi

                  payload=$(jq -n \
                    --arg repo "$SDK_REPO" \
                    --arg sdk_ref "$SDK_REF" \
                    --arg benchmarks_repo "$BENCHMARKS_REPO" \
                    --arg benchmarks_ref "$BENCHMARKS_REF" \
                    --arg pr "$PR_NUMBER" \
                    --arg instances "$EVAL_INSTANCES" \
                    --arg model_id "$MODEL_ID" \
                    --arg llm_model "$LLM_MODEL" \
                    --arg trigger_desc "$TRIGGER_DESC" \
                    --arg trigger_type "$TRIGGER_TYPE" \
                    '{
                      "ref": "main",
                      "inputs": {
                        "sdk-repo": $repo,
                        "sdk-ref": $sdk_ref,
                        "benchmarks-repo": $benchmarks_repo,
                        "benchmarks-ref": $benchmarks_ref,
                        "pr-number": $pr,
                        "eval-instances": $instances,
                        "llm-model-id": $model_id,
                        "llm-model": $llm_model,
                        "trigger-description": $trigger_desc,
                        "trigger_type": $trigger_type
                      }
                    }')

                  curl -sS -X POST \
                    -H "Authorization: Bearer $PAT_TOKEN" \
                    -H "Accept: application/vnd.github+json" \
                    -d "$payload" \
                    https://api.github.com/repos/OpenHands/evaluation/actions/workflows/create-sdk-eval.yml/dispatches

            - name: Notify Slack
              env:
                  SLACK_TOKEN: ${{ secrets.SLACK_TOKEN }}
                  TRIGGER_DESC: ${{ steps.params.outputs.trigger_desc }}
                  TRIGGER_URL: ${{ steps.params.outputs.trigger_url }}
                  SDK_REF: ${{ steps.params.outputs.sdk_ref }}
                  MODELS_TEXT: ${{ steps.params.outputs.models_text }}
              run: |
                  if [ -z "$SLACK_TOKEN" ]; then
                    echo "SLACK_TOKEN not configured; skipping Slack notification"
                    exit 0
                  fi
                  link="$TRIGGER_DESC"
                  if [ -n "$TRIGGER_URL" ]; then
                    link="$TRIGGER_DESC ($TRIGGER_URL)"
                  fi
                  text="SDK eval proxy triggered for $link on ref $SDK_REF with models: $MODELS_TEXT."
                  curl -sS -X POST -H 'Content-type: application/json' \
                    --data "{\"text\":\"$text\"}" \
                    https://hooks.slack.com/services/$SLACK_TOKEN
